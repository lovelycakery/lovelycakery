<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日曆 - Lovely Cakery</title>
    <link rel="stylesheet" href="assets/css/styles.css?v=20251225-2">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
</head>
<body class="calendar-page-body">
    <header class="header">
        <div class="container">
            <div class="nav-wrapper">
                <h1 class="logo"><a href="index.html" style="text-decoration: none; color: inherit;">Lovely Cakery</a></h1>
                <div class="nav-right">
                    <nav class="nav">
                        <a href="index.html" class="nav-link" data-en="HOME" data-zh="首頁">首頁</a>
                        <span class="nav-separator">|</span>
                        <a href="calendar.html" class="nav-link" data-en="CALENDAR" data-zh="日曆">日曆</a>
                        <span class="nav-separator">|</span>
                        <a href="seasonal.html" class="nav-link" data-en="SEASONAL" data-zh="季節限定">季節限定</a>
                        <span class="nav-separator">|</span>
                        <a href="all-items.html" class="nav-link" data-en="ALL ITEMS" data-zh="全部品項">全部品項</a>
                        <span class="nav-separator">|</span>
                        <a href="order.html" class="nav-link" data-en="ORDER" data-zh="訂購方式">訂購方式</a>
                        <span class="nav-separator">|</span>
                        <a href="contact.html" class="nav-link" data-en="CONTACT" data-zh="聯絡">聯絡</a>
                    </nav>
                    <div class="social-links">
                        <a href="https://www.facebook.com/lovelycakery2025/" target="_blank" rel="noopener noreferrer" class="social-link" aria-label="Facebook">
                            <svg class="social-icon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                            </svg>
                        </a>
                        <a href="https://www.instagram.com/lovelycakery2022/" target="_blank" rel="noopener noreferrer" class="social-link" aria-label="Instagram">
                            <svg class="social-icon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                            </svg>
                        </a>
                    </div>
                    <div class="language-switcher">
                        <button class="lang-btn active" data-lang="zh">中文</button>
                        <span class="lang-separator">|</span>
                        <button class="lang-btn" data-lang="en">EN</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="main-content calendar-page">
        <div class="container">
            <!-- 嵌入只讀日曆組件 -->
            <div class="calendar-wrapper">
                <div class="calendar-scale">
                    <div class="calendar-scale-inner">
                        <iframe 
                            src="calendar-widget-readonly.html?v=20251225-2" 
                            class="calendar-iframe"
                            title="Calendar Widget"
                            frameborder="0"
                            scrolling="no">
                        </iframe>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <script src="assets/js/script.js"></script>
    <script>
        function updateCalendarScale() {
            const header = document.querySelector('.header');
            const page = document.querySelector('.calendar-page');
            const container = page ? page.querySelector('.container') : null;
            const scaleBox = document.querySelector('.calendar-scale');
            const inner = document.querySelector('.calendar-scale-inner');
            const iframe = document.querySelector('.calendar-iframe');
            if (!page || !iframe) return;

            const headerH = header ? header.offsetHeight : 100;
            document.documentElement.style.setProperty('--header-h', headerH + 'px');

            // 以日曆頁可用區域為準（扣掉 header 後就是這塊）
            // 寬度要以 container 為準（container 有左右 padding，否則會算太寬導致右邊被裁）
            let availW = (container ? container.clientWidth : page.clientWidth);
            if (container) {
                const cs = getComputedStyle(container);
                const padL = parseFloat(cs.paddingLeft) || 0;
                const padR = parseFloat(cs.paddingRight) || 0;
                // 子元素實際可用的是 content box（clientWidth 會把 padding 算進去）
                availW = Math.max(0, availW - padL - padR);
            }
            const availH = page.clientHeight;

            // 日曆設計寬度（與 calendar-widget.css 的 max-width 對齊）
            const contentW = 900;
            // 內容高度以 iframe 真實高度為準（未縮放）
            const contentH = Math.max(1, iframe.offsetHeight);

            // 讓 CSS 能計算縮放後的「佔位」寬高，避免裁切
            document.documentElement.style.setProperty('--cal-content-w', contentW + 'px');
            document.documentElement.style.setProperty('--cal-content-h', contentH + 'px');

            // 給 box-shadow 的安全 padding（calendar-scale 會有 padding）
            let shadowPad = 24;
            if (scaleBox) {
                const sb = getComputedStyle(scaleBox);
                shadowPad = parseFloat(sb.paddingLeft) || shadowPad;
            }

            // 偏上位移會吃掉上方空間，縮放計算要把它算進去，避免頂端被裁
            const shiftRaw = getComputedStyle(document.documentElement).getPropertyValue('--cal-shift').trim();
            const shiftPx = shiftRaw.endsWith('px') ? parseFloat(shiftRaw) : 0;
            const extraTop = Math.max(0, -shiftPx);
            const extraBottom = Math.max(0, shiftPx);

            const padding = 12; // 留白（縮小一點，讓整體放大一些）
            // 需要把 shadowPad 也算進去，否則縮放後會剛好貼邊導致陰影/邊框被裁
            const scaleW = (availW - padding * 2 - shadowPad * 2) / contentW;
            const scaleH = (availH - padding * 2 - shadowPad * 2 - extraTop - extraBottom) / contentH;
            // 直接用可用寬高計算的最大縮放（佔位已加 buffer，避免裁切）
            const scale = Math.min(1, scaleW, scaleH);

            document.documentElement.style.setProperty('--cal-scale', String(scale));

            // 把「縮放後佔位」直接寫到外層盒子，避免 transform 不影響佔位造成裁切
            if (scaleBox) {
                // 加 2px buffer，避免小數 rounding 剪到邊
                scaleBox.style.width = (Math.ceil(contentW * scale) + shadowPad * 2 + 2) + 'px';
                scaleBox.style.height = (Math.ceil(contentH * scale) + shadowPad * 2 + 2) + 'px';
            }
            if (inner) {
                inner.style.width = contentW + 'px';
                inner.style.height = contentH + 'px';
            }
        }

        // 自動調整 iframe 高度以適應內容
        function resizeIframe() {
            const iframe = document.querySelector('.calendar-iframe');
            if (!iframe) return;
            
            try {
                const iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
                if (iframeDocument && iframeDocument.body) {
                    // 獲取內容的實際高度，包括所有元素
                    const bodyHeight = iframeDocument.body.scrollHeight || iframeDocument.body.offsetHeight;
                    const docHeight = iframeDocument.documentElement.scrollHeight || iframeDocument.documentElement.offsetHeight;
                    const clientHeight = iframeDocument.documentElement.clientHeight;
                    const height = Math.max(bodyHeight, docHeight, clientHeight);
                    
                    if (height > 0) {
                        // 增加更多額外空間確保完整顯示（包括底部邊距和可能的滾動條）
                        iframe.style.height = (height + 120) + 'px';
                        updateCalendarScale();
                    }
                }
            } catch (e) {
                // 跨域限制時，保持 min-height
                console.log('無法獲取 iframe 內容高度:', e);
            }
        }

        // 頁面加載完成後調整
        window.addEventListener('load', function() {
            resizeIframe();
            updateCalendarScale();
            setTimeout(resizeIframe, 300);
            setTimeout(resizeIframe, 600);
            setTimeout(resizeIframe, 1000);
            setTimeout(resizeIframe, 1500);
            setTimeout(resizeIframe, 2000);
        });

        // 監聽 iframe 加載完成
        const iframe = document.querySelector('.calendar-iframe');
        if (iframe) {
            iframe.addEventListener('load', function() {
                setTimeout(resizeIframe, 200);
                setTimeout(resizeIframe, 500);
                setTimeout(resizeIframe, 1000);
                setTimeout(resizeIframe, 1500);
                setTimeout(resizeIframe, 2000);
            });
        }
        
        // 監聽來自 iframe 的 postMessage
        window.addEventListener('message', function(event) {
            // 安全檢查：只接受來自同源的訊息（本地文件時允許所有來源）
            if (event.data && event.data.type === 'calendar-resize') {
                const iframe = document.querySelector('.calendar-iframe');
                if (iframe && event.data.height > 0) {
                    // 設置明確的高度，確保日曆完整顯示
                    // 注意：不使用 scale 調整高度，因為 transform scale 只影響視覺
                    iframe.style.height = event.data.height + 'px';
                    iframe.style.minHeight = event.data.height + 'px';
                    updateCalendarScale();
                }
            }
        });

        // 視窗大小改變時，重新計算縮放（避免手機地址列、桌面縮放影響）
        window.addEventListener('resize', function() {
            // 等下一幀再算，避免 layout 還沒更新
            window.requestAnimationFrame(updateCalendarScale);
        });
    </script>
</body>
</html>

